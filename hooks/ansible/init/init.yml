---
- hosts: jenkins_slave
  tasks:

    - name: Add EPEL repository
      yum_repository:
        name: epel
        description: EPEL YUM repo
        baseurl: "https://download.fedoraproject.org/pub/epel/7/{{ lookup('env', 'ARCH') }}/"

    - name: Add RHEL NIGHTLY repository
      yum_repository:
        name: rhel-nightly
        description: RHEL NIGHTLY YUM repo
        baseurl: "http://download.eng.bos.redhat.com/composes/nightly/EXTRAS-RHEL-7.4/latest-EXTRAS-7-RHEL-7/compose/Server/{{ lookup('env', 'ARCH') }}/os"
        gpgkey:
          - "http://download.eng.bos.redhat.com/composes/nightly/EXTRAS-RHEL-7.4/latest-EXTRAS-7-RHEL-7/compose/Server/{{ lookup('env', 'ARCH') }}/os/RPM-GPG-KEY-redhat-beta"
          - "http://download.eng.bos.redhat.com/composes/nightly/EXTRAS-RHEL-7.4/latest-EXTRAS-7-RHEL-7/compose/Server/{{ lookup('env', 'ARCH') }}/os/RPM-GPG-KEY-redhat-release"

    - name: Install dependencies
      yum: pkg={{item}} state=installed disable_gpg_check=yes
      with_items:
      - bc
      - git
      - make
      - golang
      - docker
      - jq
      - bind-utils

    - name: Adding docker group to system
      group:
        name: docker
        state: present
        system: yes

    - name: Adding existing user jenkins to group docker
      user: name=jenkins
            groups=docker
            append=yes 

    - lineinfile:
        path: /etc/containers/registries.conf
        line: 'insecure_registries:'

    - lineinfile:
        path: /etc/containers/registries.conf
        line: '  - 172.30.0.0/16'

    - service: name=docker state=started
