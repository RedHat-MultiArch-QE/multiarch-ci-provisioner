/**
 * Jenkinsfile
 *
 * Jenkins Pipeline to build and manage Atomic OpenShift
 */
properties([
    parameters([
        string(
          name: 'BUILD_NUMBER',
          description: 'Build number of the cinchpin run',
        )
      ])
  ])
node ('jenkins-slave') {
    ansiColor('xterm') {
        timestamps {

            // Prepare the cinch teardown inventory
            stage('Setup') {
                dir('ci-pipeline') {
                    // Clone the provisioning setup
                    git 'https://github.com/jaypoulz/multiarch-ci-pipeline'
                    
                    // Copy artifacts from build 
                    step([$class: 'CopyArtifact', filter: 'inventories/cinch.inventory',
                          fingerprintArtifacts: true,
                          flatten             : true,
                          projectName         : 'provision-multiarch-slave',
                          selector            : [$class     : 'SpecificBuildSelector', buildNumber: parameters.BUILD_NUMBER]])
                    step([$class: 'CopyArtifact', filter: 'resources/cinch.output',
                          fingerprintArtifacts: true,
                          flatten             : true,
                          projectName         : 'provision-multiarch-slave',
                          selector            : [$class     : 'SpecificBuildSelector', buildNumber: parameters.BUILD_NUMBER]])
                    
                }
            }

            // Preform the actual teardown
            stage('Teardown') {
                dir('ci-pipeline') {
                    sh 'cinchpin destroy'
                }
            }
        }
    }
}
